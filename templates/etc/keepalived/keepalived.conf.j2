# {{ ansible_managed }}

global_defs {
  notification_email {
  {% for notification_email in keepalived_global_defs_notification_email -%}
    {{ notification_email }}
  {% endfor -%}
  }
  notification_email_from {{ keepalived_global_defs_notification_email_from }}
  smtp_server {{ keepalived_global_defs_smtp_server }}
  smtp_connect_timeout {{ keepalived_global_defs_smtp_connect_timeout }}
}

{% for key, value in keepalived_vrrp_scripts.iteritems() -%}
vrrp_script {{ key }} {
  script "{{ value.script }}"
  {% if value.weight is defined -%}
  weight {{ value.weight }}
  {% endif -%}
  {% if value.interval is defined and value.interval | int -%}
  interval {{ value.interval }}
  {% endif -%}
}
{% endfor -%}

{% for key, value in keepalived_vrrp_instances.iteritems() %}
vrrp_instance {{ key }} {
  interface {{ value.interface }}
  state {{ value.state }}
  priority {{ value.priority }}
  virtual_router_id {{ value.virtual_router_id }}
  {% if value.advert_int is defined and value.advert_int | int -%}
  advert_int {{ value.advert_int }}
  {% endif -%}

  {% if value.smtp_alert is defined and value.smtp_alert | bool -%}
  smtp_alert
  {% endif -%}

  authentication {
    auth_type {{ value.authentication.auth_type }}
    auth_pass {{ value.authentication.auth_pass }}
  }

  virtual_ipaddress {
  {% for virtual_ipaddress in value.virtual_ipaddresses %}
  {{ virtual_ipaddress }}
  {% endfor -%}}

  {% if track_script is defined -%}
  track_script {
  {% for track_script in value.track_scripts %}
  {{ track_script }}
  {% endfor -%}
  }
{% endif -%}
}
{% endfor %}

{% if keepalived_ipvs_servers is defined %}
{% for key, value in keepalived_ipvs_servers.iteritems() -%}
# {{ key }}
virtual_server {{ value.virtual_server_ip }} {{ value.virtual_server_port }} {
  delay_loop {{ value.delay_loop | default('3') }}
  lb_algo {{ value.lb_algo | default('rr') }}
  lb_kind {{ value.lb_kind | default('DR') }}
  protocol {{ value.protocol | default('TCP') }}
  {% if  persistence_timeout is defined -%}
  persistence_timeout {{  persistence_timeout }}
  {% endif -%}
  {% if value.ha_suspend is defined and ha_suspend | bool -%}
  ha_suspend
  {% endif %}

  {% for key, value in value.real_servers.iteritems() -%}
  # {{ key }}
  real_server {{ value.real_server_ip }} {{ value.real_server_port }} {
    weight {{ value.weight | default('1') }}
    {% if value.tcp_check -%}
      TCP_CHECK {
        connect_port {{ value.real_server_port }}
        connect_timeout {{ connect_timeout | default('3') }}
    }
  {% endif -%}
}
  {% endfor -%}
}
{% endfor -%}
{% endif %}